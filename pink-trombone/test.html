<html>
  <head>
    <style>
      body {
        background: #111;
        color: #ffe600;
        font-family: 'Segoe UI', 'Arial', sans-serif;
        margin: 0;
        min-height: 100vh;
      }
      nav, a {
        color: #39ff14;
        text-shadow: 0 0 4px #39ff14;
        font-weight: bold;
      }
      a:hover {
        color: #fff;
        text-shadow: 0 0 8px #ffe600, 0 0 16px #39ff14;
      }
      button {
        background: #111;
        color: #ffe600;
        border: 2px solid #39ff14;
        border-radius: 6px;
        box-shadow: 0 0 8px #39ff14, 0 0 2px #ffe600;
        padding: 0.5em 1.2em;
        margin: 0.3em 0;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      }
      button:hover {
        background: #ffe600;
        color: #111;
        box-shadow: 0 0 16px #ffe600, 0 0 8px #39ff14;
      }
      input, select {
        background: #222;
        color: #ffe600;
        border: 1.5px solid #39ff14;
        border-radius: 4px;
        box-shadow: 0 0 4px #39ff14;
        margin: 0.2em 0;
        padding: 0.3em;
      }
      ::selection {
        background: #ffe600;
        color: #111;
      }
      /* Neon border for main content */
      body > *:not(nav) {
        border-radius: 10px;
        box-shadow: 0 0 24px #ffe60044, 0 0 8px #39ff1444;
        margin: 1.5em auto;
        max-width: 900px;
        padding: 1.5em 2em;
        background: rgba(20,20,20,0.92);
      }
    </style>
    <script src="/src/utils.js"></script>

    <script src="/pink-trombone/src/pink-trombone.min.js" type="module"></script>
  </head>

  <body>
    <nav>
      <a href="../../">home</a>
    </nav>
    <div style="position: absolute; left: 0; top: 0; z-index: 100">
      <select id="microphoneSelect" hidden>
        <optgroup id="microphoneOptGroup" label="select microphone"></optgroup>
      </select>
      <button id="toggleMicrophone">enable microphone</button>
      <button id="debugMicrophone" hidden>listen to mirophone</button>
    </div>

    <pink-trombone></pink-trombone>

    <script>
      const audioContext = new AudioContext();
      autoResumeAudioContext(audioContext);

      const pinkTromboneElement = document.querySelector("pink-trombone");

      pinkTromboneElement.addEventListener("load", (event) => {
        pinkTromboneElement.setAudioContext(audioContext).then((pinkTrombone) => {
          pinkTromboneElement.enableUI();
          pinkTromboneElement.startUI();
          pinkTromboneElement.connect(pinkTromboneElement.audioContext.destination);
        });
      });
    </script>

    <script>
      /** @type {MediaStream|undefined} */
      var mediaStream;
      /** @type {MediaStreamAudioSourceNode|undefined} */
      var mediaStreamSourceNode;
      const toggleMicrophoneButton = document.getElementById("toggleMicrophone");
      toggleMicrophoneButton.addEventListener("click", async () => {
        if (isMicrophoneOn()) {
          stopMicrophone();
        } else {
          await getMicrophone();
        }
      });

      const isMicrophoneOn = () => {
        return Boolean(mediaStream);
      };

      const getMicrophone = async () => {
        stopMicrophone();

        mediaStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            deviceId: microphoneSelect.value ? microphoneSelect.value : true,
            autoGainControl: false,
            noiseSuppression: false,
            echoCancellation: false,
          },
        });
        mediaStreamSourceNode = audioContext.createMediaStreamSource(mediaStream);
        mediaStreamSourceNode.connect(pinkTromboneElement.pinkTrombone._pinkTromboneNode);
        pinkTromboneElement.pinkTrombone._fricativeFilter.disconnect();
        pinkTromboneElement.pinkTrombone._aspirateFilter.disconnect();

        debugMicrophoneButton.removeAttribute("hidden");
        toggleMicrophoneButton.innerText = "disable microphone";
      };
      const stopMicrophone = () => {
        if (mediaStream) {
          mediaStream.getTracks().forEach((track) => track.stop());
          mediaStream = undefined;
          mediaStreamSourceNode?.disconnect();
          mediaStreamSourceNode = undefined;
          isListeningToMicrophone = false;
          debugMicrophoneButton.setAttribute("hidden", "");
          toggleMicrophoneButton.innerText = "enable microphone";

          pinkTromboneElement.pinkTrombone._fricativeFilter.connect(
            pinkTromboneElement.pinkTrombone._pinkTromboneNode.noise
          );
          pinkTromboneElement.pinkTrombone._aspirateFilter.connect(
            pinkTromboneElement.pinkTrombone._pinkTromboneNode.noise
          );
        }
      };

      /** @type {HTMLSelectElement} */
      const microphoneSelect = document.getElementById("microphoneSelect");
      /** @type {HTMLOptGroupElement} */
      const microphoneOptGroup = document.getElementById("microphoneOptGroup");
      const updateMicrophoneSelect = async () => {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const microphones = devices.filter((device) => device.kind == "audioinput");
        if (microphones.length > 0) {
          microphoneSelect.removeAttribute("hidden");
          microphoneOptGroup.innerHTML = "";
          microphones.forEach((microphone) => {
            microphoneOptGroup.appendChild(new Option(microphone.label, microphone.deviceId));
          });
        } else {
          microphoneSelect.setAttribute("hidden", "");
        }
      };
      navigator.mediaDevices.addEventListener("devicechange", () => {
        updateMicrophoneSelect();
      });
      updateMicrophoneSelect();

      microphoneSelect.addEventListener("input", async () => {
        if (isMicrophoneOn()) {
          await getMicrophone();
        }
      });

      var isListeningToMicrophone = false;
      const debugMicrophoneButton = document.getElementById("debugMicrophone");
      debugMicrophoneButton.addEventListener("click", () => {
        if (mediaStreamSourceNode) {
          isListeningToMicrophone = !isListeningToMicrophone;
          if (isListeningToMicrophone) {
            mediaStreamSourceNode.connect(audioContext.destination);
            debugMicrophoneButton.innerText = "stop listening to microphone";
          } else {
            mediaStreamSourceNode.disconnect(audioContext.destination);
            debugMicrophoneButton.innerText = "listen to microphone";
          }
        }
      });
    </script>
  </body>
</html>
